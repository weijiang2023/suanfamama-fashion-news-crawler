{% extends 'base.html' %}
{% block content %}
<div class="row">
  <div class="col-lg-3 mb-4">
    <div class="card">
      <div class="card-header">Filters</div>
      <div class="card-body">
        <form method="get" action="/">
          <div class="mb-3">
            <label class="form-label">Keyword</label>
            <input class="form-control" type="text" name="q" value="{{ args.get('q','') }}" />
          </div>
          <div class="mb-3">
            <label class="form-label">Source</label>
            <select class="form-select" name="source">
              <option value="">All</option>
              {% for s in sources %}
                <option value="{{ s['source'] }}" {% if args.get('source') == s['source'] %}selected{% endif %}>{{ s['source'] }} ({{ s['c'] }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Category</label>
            <select class="form-select" name="category">
              <option value="">All</option>
              {% for c in categories %}
                {% if c['category'] %}
                  <option value="{{ c['category'] }}" {% if args.get('category') == c['category'] %}selected{% endif %}>{{ c['category'] }} ({{ c['c'] }})</option>
                {% endif %}
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Within days</label>
            <input class="form-control" type="number" name="days" value="{{ args.get('days','') }}" placeholder="e.g. 7" />
          </div>
          <div class="mb-3">
            <label class="form-label">Per page</label>
            <input class="form-control" type="number" name="per_page" min="5" max="100" value="{{ per_page }}" />
          </div>
          <button class="btn btn-primary w-100" type="submit">Apply</button>
        </form>
      </div>
    </div>
  </div>
  <div class="col-lg-9">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div><strong>{{ total }}</strong> results</div>
      <div>Page {{ page }} of {{ (total // per_page) + (1 if total % per_page else 0) }}</div>
    </div>
    <div class="row g-3">
      {% for r in rows %}
      <div class="col-12">
        <div class="card article-card">
          <div class="row g-0">
            {% if r['top_image'] %}
            <div class="col-md-3">
              <img src="{{ r['top_image'] }}" class="img-fluid rounded-start" alt="thumbnail" />
            </div>
            <div class="col-md-9">
            {% else %}
            <div class="col-md-12">
            {% endif %}
              <div class="card-body">
                <h5 class="card-title"><a href="{{ url_for('article_detail', article_id=r['id']) }}">{{ r['title'] or 'Untitled' }}</a></h5>
                <div class="text-muted mb-2">
                  {{ r['source'] }}{% if r['category'] %} · {{ r['category'] }}{% endif %}
                  {% if r['published_at'] %} · {{ r['published_at'][:19].replace('T',' ') }}{% endif %}
                </div>
                <p class="card-text truncate-4">{{ r['summary'] or r['snippet'] }}</p>
                <a class="btn btn-sm btn-outline-secondary" href="{{ r['url'] }}" target="_blank" rel="noopener">Original</a>
                <a class="btn btn-sm btn-primary" href="{{ url_for('article_detail', article_id=r['id']) }}">Read</a>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <nav class="mt-3">
      <ul class="pagination">
        {% set total_pages = (total // per_page) + (1 if total % per_page else 0) %}
        {% set query_args = args.to_dict() %}
        {% if page > 1 %}
          {% set query_args = query_args.update({'page': 1}) %}
          <li class="page-item"><a class="page-link" href="?{{ request.query_string|safe.replace('page=' ~ page, 'page=1') }}">First</a></li>
          <li class="page-item"><a class="page-link" href="?{{ request.query_string|safe.replace('page=' ~ page, 'page=' ~ (page-1)) }}">Prev</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">First</span></li>
          <li class="page-item disabled"><span class="page-link">Prev</span></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">{{ page }}</span></li>
        {% if page < total_pages %}
          <li class="page-item"><a class="page-link" href="?{{ request.query_string|safe.replace('page=' ~ page, 'page=' ~ (page+1)) }}">Next</a></li>
          <li class="page-item"><a class="page-link" href="?{{ request.query_string|safe.replace('page=' ~ page, 'page=' ~ total_pages) }}">Last</a></li>
        {% else %}
          <li class="page-item disabled"><span class="page-link">Next</span></li>
          <li class="page-item disabled"><span class="page-link">Last</span></li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>
{% endblock %}